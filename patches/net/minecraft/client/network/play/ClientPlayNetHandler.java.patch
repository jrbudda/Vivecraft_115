--- a/net/minecraft/client/network/play/ClientPlayNetHandler.java
+++ b/net/minecraft/client/network/play/ClientPlayNetHandler.java
@@ -1,5 +1,6 @@
 package net.minecraft.client.network.play;
 
+import com.google.common.base.Charsets;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
 import com.mojang.authlib.GameProfile;
@@ -288,7 +289,10 @@
 import net.minecraft.util.math.MutableBoundingBox;
 import net.minecraft.util.math.SectionPos;
 import net.minecraft.util.math.Vec3d;
+import net.minecraft.util.registry.Registry;
+import net.minecraft.util.text.ChatType;
 import net.minecraft.util.text.ITextComponent;
+import net.minecraft.util.text.StringTextComponent;
 import net.minecraft.util.text.TranslationTextComponent;
 import net.minecraft.world.Explosion;
 import net.minecraft.world.GameType;
@@ -299,8 +303,15 @@
 import net.minecraft.world.dimension.DimensionType;
 import net.minecraft.world.lighting.WorldLightManager;
 import net.minecraft.world.storage.MapData;
+import net.optifine.reflect.Reflector;
+
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.vivecraft.api.NetworkHelper;
+import org.vivecraft.api.ServerVivePlayer;
+import org.vivecraft.api.NetworkHelper.PacketDiscriminators;
+import org.vivecraft.provider.MCOpenVR;
+import org.vivecraft.render.PlayerModelController;
 
 public class ClientPlayNetHandler implements IClientPlayNetHandler
 {
@@ -368,6 +379,9 @@
 
         this.client.debugRenderer.clear();
         this.client.player.preparePlayerToSpawn();
+        //Forge
+        Reflector.call(Reflector.ClientHooks_firePlayerLogin, this.client.playerController, this.client.player, this.client.getConnection().getNetworkManager());
+        //
         int i = packetIn.getPlayerId();
         this.world.addPlayer(i, this.client.player);
         this.client.player.movementInput = new MovementInputFromOptions(this.client.gameSettings);
@@ -379,9 +393,15 @@
         this.client.player.setReducedDebug(packetIn.isReducedDebugInfo());
         this.client.player.setShowDeathScreen(packetIn.func_229743_k_());
         this.client.playerController.setGameType(packetIn.getGameType());
+        //Forge
+        Reflector.call(Reflector.NetworkHooks_sendMCRegistryPackets, netManager, "PLAY_TO_SERVER");
+        //
         this.client.gameSettings.sendSettingsToServer();
         this.netManager.sendPacket(new CCustomPayloadPacket(CCustomPayloadPacket.BRAND, (new PacketBuffer(Unpooled.buffer())).writeString(ClientBrandRetriever.getClientModName())));
         this.client.getMinecraftGame().startGameSession();
+        // VIVE START - ask server if it's running this mod
+        NetworkHelper.sendVersionInfo();
+        // VIVE END - ask server if it's running this mod
     }
 
     public void handleSpawnObject(SSpawnObjectPacket packetIn)
@@ -872,7 +892,10 @@
 
             if (tileentity != null)
             {
-                tileentity.read(compoundnbt);
+            	if(Reflector.IForgeTileEntity_handleUpdateTag.exists())
+            		Reflector.call(tileentity, Reflector.IForgeTileEntity_handleUpdateTag, compoundnbt);
+            	else
+            		tileentity.read(compoundnbt);
             }
         }
     }
@@ -966,8 +989,14 @@
 
     public void handleChat(SChatPacket packetIn)
     {
-        PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
-        this.client.ingameGUI.addChatMessage(packetIn.getType(), packetIn.getChatComponent());
+    	PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
+    	
+        net.minecraft.util.text.ITextComponent message = (ITextComponent) Reflector.call(Reflector.ForgeEventFactory_onClientChat, packetIn.getType(), packetIn.getChatComponent());
+        if (message == null)     	
+        	this.client.ingameGUI.addChatMessage(packetIn.getType(), packetIn.getChatComponent());
+        else
+        	this.client.ingameGUI.addChatMessage(packetIn.getType(), message);
+
     }
 
     public void handleAnimation(SAnimateHandPacket packetIn)
@@ -1100,7 +1129,9 @@
 
                     if (entity1 == this.client.player && !flag)
                     {
-                        this.client.ingameGUI.setOverlayMessage(I18n.format("mount.onboard", this.client.gameSettings.keyBindSneak.getLocalizedName()), false);
+                    	//Vivecraft - use key name, not keyboard key
+                        this.client.ingameGUI.setOverlayMessage(I18n.format("mount.onboard", this.client.gameSettings.keyBindSneak.getKeyDescription()), false);
+                        //
                     }
                 }
             }
@@ -1191,6 +1222,9 @@
             this.world.setScoreboard(scoreboard);
             this.client.loadWorld(this.world);
             this.client.displayGuiScreen(new DownloadTerrainScreen());
+            //VIVECRAFT          
+            NetworkHelper.sendVersionInfo();
+            //
         }
 
         this.world.setInitialSpawnLocation();
@@ -1204,8 +1238,14 @@
         this.client.renderViewEntity = clientplayerentity1;
         clientplayerentity1.getDataManager().setEntryValues(clientplayerentity.getDataManager().getAll());
         clientplayerentity1.getAttributes().func_226303_a_(clientplayerentity.getAttributes());
+        // Forge: fix MC-10657        
+        Reflector.call(clientplayerentity1,  Reflector.ForgeClientPlayerEntity_updateSyncFields, clientplayerentity);
+        //       
         clientplayerentity1.preparePlayerToSpawn();
         clientplayerentity1.setServerBrand(s);
+        //Forge
+        Reflector.call(Reflector.ClientHooks_firePlayerRespawn, this.client.playerController, clientplayerentity, clientplayerentity1, clientplayerentity1.connection.getNetworkManager());
+        //
         this.world.addPlayer(i, clientplayerentity1);
         clientplayerentity1.rotationYaw = -180.0F;
         clientplayerentity1.movementInput = new MovementInputFromOptions(this.client.gameSettings);
@@ -1305,7 +1345,7 @@
     {
         PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
         Container container = null;
-        PlayerEntity playerentity = this.client.player;
+        ClientPlayerEntity playerentity = this.client.player;
 
         if (packetIn.getWindowId() == 0)
         {
@@ -1320,6 +1360,7 @@
         {
             this.sendPacket(new CConfirmTransactionPacket(packetIn.getWindowId(), packetIn.getActionNumber(), true));
         }
+        
     }
 
     public void handleWindowItems(SWindowItemsPacket packetIn)
@@ -1353,24 +1394,32 @@
 
     public void handleUpdateTileEntity(SUpdateTileEntityPacket packetIn)
     {
-        PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
-
-        if (this.client.world.isBlockLoaded(packetIn.getPos()))
-        {
-            TileEntity tileentity = this.client.world.getTileEntity(packetIn.getPos());
-            int i = packetIn.getTileEntityType();
-            boolean flag = i == 2 && tileentity instanceof CommandBlockTileEntity;
+    	PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
 
-            if (i == 1 && tileentity instanceof MobSpawnerTileEntity || flag || i == 3 && tileentity instanceof BeaconTileEntity || i == 4 && tileentity instanceof SkullTileEntity || i == 6 && tileentity instanceof BannerTileEntity || i == 7 && tileentity instanceof StructureBlockTileEntity || i == 8 && tileentity instanceof EndGatewayTileEntity || i == 9 && tileentity instanceof SignTileEntity || i == 11 && tileentity instanceof BedTileEntity || i == 5 && tileentity instanceof ConduitTileEntity || i == 12 && tileentity instanceof JigsawTileEntity || i == 13 && tileentity instanceof CampfireTileEntity || i == 14 && tileentity instanceof BeehiveTileEntity)
-            {
-                tileentity.read(packetIn.getNbtCompound());
-            }
-
-            if (flag && this.client.currentScreen instanceof CommandBlockScreen)
-            {
-                ((CommandBlockScreen)this.client.currentScreen).updateGui();
-            }
-        }
+    	if (this.client.world.isBlockLoaded(packetIn.getPos()))
+    	{
+    		TileEntity tileentity = this.client.world.getTileEntity(packetIn.getPos());
+    		int i = packetIn.getTileEntityType();
+    		boolean flag = i == 2 && tileentity instanceof CommandBlockTileEntity;
+
+    		if (i == 1 && tileentity instanceof MobSpawnerTileEntity || flag || i == 3 && tileentity instanceof BeaconTileEntity || i == 4 && tileentity instanceof SkullTileEntity || i == 6 && tileentity instanceof BannerTileEntity || i == 7 && tileentity instanceof StructureBlockTileEntity || i == 8 && tileentity instanceof EndGatewayTileEntity || i == 9 && tileentity instanceof SignTileEntity || i == 11 && tileentity instanceof BedTileEntity || i == 5 && tileentity instanceof ConduitTileEntity || i == 12 && tileentity instanceof JigsawTileEntity || i == 13 && tileentity instanceof CampfireTileEntity || i == 14 && tileentity instanceof BeehiveTileEntity)
+    		{
+    			tileentity.read(packetIn.getNbtCompound());
+    		} else {
+    			//Forge
+    			if(tileentity == null) {
+    				LOGGER.error("Received invalid update packet for null tile entity at {} with data: {}", packetIn.getPos(), packetIn.getNbtCompound());
+    				return;
+    			}
+    			Reflector.call(tileentity, Reflector.IForgeTileEntity_onDataPacket, netManager, packetIn);
+    			//
+    		}
+
+    		if (flag && this.client.currentScreen instanceof CommandBlockScreen)
+    		{
+    			((CommandBlockScreen)this.client.currentScreen).updateGui();
+    		}
+    	}
     }
 
     public void handleWindowProperty(SWindowPropertyPacket packetIn)
@@ -1599,6 +1648,9 @@
         clientrecipebook.rebuildTable();
         clientrecipebook.getRecipes().forEach(imutablesearchtree::func_217872_a);
         imutablesearchtree.recalculate();
+        //Forge
+        Reflector.call(Reflector.ForgeHooksClient_onRecipesUpdated, this.recipeManager);
+        //
     }
 
     public void handlePlayerLook(SPlayerLookPacket packetIn)
@@ -1702,7 +1754,7 @@
 
         if (entity instanceof LivingEntity)
         {
-            Effect effect = Effect.get(packetIn.getEffectId());
+            Effect effect = Effect.get(packetIn.getEffectId() & 0xFF); //Forge FF
 
             if (effect != null)
             {
@@ -1727,6 +1779,9 @@
         }
 
         this.client.getSearchTree(SearchTreeManager.TAGS).recalculate();
+        //Forge
+        Reflector.postForgeBusEvent(Reflector.TagsUpdatedEvent_Constructor, this.networkTagManager);
+        //
     }
 
     public void handleCombatEvent(SCombatPacket packetIn)
@@ -2081,7 +2136,7 @@
         PacketThreadUtil.checkThreadAndEnqueue(packetIn, this, this.client);
         ResourceLocation resourcelocation = packetIn.getChannelName();
         PacketBuffer packetbuffer = null;
-
+        boolean release = true;
         try
         {
             packetbuffer = packetIn.getBufferData();
@@ -2344,14 +2399,69 @@
                 int l5 = packetbuffer.readInt();
                 this.client.debugRenderer.field_229018_q_.func_229022_a_(blockpos7, l3, s10, l5);
             }
+    		else if (resourcelocation.getNamespace().equalsIgnoreCase("vivecraft"))
+    		{ 			
+    			// VIVE START - server told us that it has this mod too, allow extended reach, etc.
+    			if (resourcelocation.getPath().equalsIgnoreCase("data"))
+    			{ 
+
+    				byte db = packetbuffer.readByte();
+    				PacketDiscriminators dis = PacketDiscriminators.values()[db];
+
+    				switch (dis){
+    				case VERSION:
+    					String v = packetbuffer.readString(1024);
+    					ITextComponent chatText = new StringTextComponent("Vivecraft server mod detected: " +  v);
+    					client.ingameGUI.getChatGUI().printChatMessage(chatText);
+    					break;
+    				case REQUESTDATA:
+    					NetworkHelper.serverWantsData = true;
+    					break;
+    				case CLIMBING:
+    					break;
+    				case TELEPORT:
+    					NetworkHelper.serverSupportsDirectTeleport = true;
+    					break;
+    				case UBERPACKET:
+    					Long hi = packetbuffer.readLong();
+    					Long low = packetbuffer.readLong();
+    					byte[] hmd = new byte[29];
+    					byte[] c0 = new byte[29];
+    					byte[] c1 = new byte[29];
+    					packetbuffer.readBytes(29).getBytes(0, hmd);
+    					packetbuffer.readBytes(29).getBytes(0, c0);
+    					packetbuffer.readBytes(29).getBytes(0, c1);
+    					UUID u = new UUID(hi, low);
+
+    					float worldscale = 1f;
+    					float heightscale = 1f;
+    					if (packetbuffer.isReadable())
+    						worldscale = packetbuffer.readFloat();
+    					if (packetbuffer.isReadable())
+    						heightscale = packetbuffer.readFloat();		
+
+    					PlayerModelController.getInstance().Update(u, hmd, c0, c1, worldscale, heightscale);    
+    						
+    					break;
+    				case SETTING_OVERRIDE:
+                        break;
+    				default:
+    					break;
+    				}
+    			}
+    		}
+    		// VIVE END
+            
             else
             {
-                LOGGER.warn("Unknown custom packed identifier: {}", (Object)resourcelocation);
+            	release = false;
+                if (!Reflector.callBoolean(Reflector.NetworkHooks_onCustomPayload, packetIn, this.netManager))               	
+                	LOGGER.warn("Unknown custom packet identifier: {}", (Object)resourcelocation);
             }
         }
         finally
         {
-            if (packetbuffer != null)
+            if (packetbuffer != null && release)
             {
                 packetbuffer.release();
             }
@@ -2536,7 +2646,7 @@
 
                     if (iattributeinstance == null)
                     {
-                        iattributeinstance = abstractattributemap.registerAttribute(new RangedAttribute((IAttribute)null, sentitypropertiespacket$snapshot.getName(), 0.0D, Double.MIN_NORMAL, Double.MAX_VALUE));
+                        iattributeinstance = abstractattributemap.registerAttribute(new RangedAttribute((IAttribute)null, sentitypropertiespacket$snapshot.getName(), 0.0D, -Double.MAX_VALUE, Double.MAX_VALUE)); // FORGE: fix invalid value range (MC-150405)
                     }
 
                     iattributeinstance.setBaseValue(sentitypropertiespacket$snapshot.getBaseValue());
@@ -2699,4 +2809,14 @@
     {
         return this.sessionId;
     }
+    //VIVECRAFT Additions
+    boolean tryParseInt(String value) {  
+    	try {  
+    		Integer.parseInt(value);  
+    		return true;  
+    	} catch (NumberFormatException e) {  
+    		return false;  
+    	}  
+    }
+    //
 }
